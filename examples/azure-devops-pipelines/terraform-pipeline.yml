trigger:
  branches:
    include:
      - main
  paths:
    include:
      - terraform/*
      - azure-pipelines-terraform.yml

pr:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: terraform-variables
  - name: terraformVersion
    value: '1.9.0'  # Update regularly to latest stable version
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)/terraform'
  - name: backendResourceGroup
    value: 'rg-terraform-state'
  - name: backendStorageAccount
    value: 'sttfstate'
  - name: backendContainerName
    value: 'tfstate'
  - name: backendKey
    value: 'prod.terraform.tfstate'

stages:
  - stage: Validate
    displayName: 'Validate Terraform'
    jobs:
      - job: ValidateJob
        displayName: 'Terraform Validation and Security Scan'
        steps:
          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: $(terraformVersion)

          - task: TerraformTaskV4@4
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: $(workingDirectory)
              backendServiceArm: 'azure-subscription'
              backendAzureRmResourceGroupName: $(backendResourceGroup)
              backendAzureRmStorageAccountName: $(backendStorageAccount)
              backendAzureRmContainerName: $(backendContainerName)
              backendAzureRmKey: $(backendKey)

          - task: TerraformTaskV4@4
            displayName: 'Terraform Format Check'
            inputs:
              provider: 'azurerm'
              command: 'custom'
              workingDirectory: $(workingDirectory)
              customCommand: 'fmt'
              commandOptions: '-check -recursive'
            continueOnError: true

          - task: TerraformTaskV4@4
            displayName: 'Terraform Validate'
            inputs:
              provider: 'azurerm'
              command: 'validate'
              workingDirectory: $(workingDirectory)

          - task: Bash@3
            displayName: 'Install tflint'
            inputs:
              targetType: 'inline'
              script: |
                curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

          - task: Bash@3
            displayName: 'Run tflint'
            inputs:
              targetType: 'inline'
              workingDirectory: $(workingDirectory)
              script: |
                tflint --init
                tflint --format compact
            continueOnError: true

          - task: Bash@3
            displayName: 'Install Checkov'
            inputs:
              targetType: 'inline'
              script: |
                pip3 install checkov

          - task: Bash@3
            displayName: 'Run Checkov Security Scan'
            inputs:
              targetType: 'inline'
              workingDirectory: $(workingDirectory)
              script: |
                checkov -d . --framework terraform --quiet --compact
            continueOnError: true

  - stage: Plan
    displayName: 'Terraform Plan'
    dependsOn: Validate
    condition: succeeded()
    jobs:
      - job: PlanJob
        displayName: 'Generate Terraform Plan'
        steps:
          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: $(terraformVersion)

          - task: TerraformTaskV4@4
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: $(workingDirectory)
              backendServiceArm: 'azure-subscription'
              backendAzureRmResourceGroupName: $(backendResourceGroup)
              backendAzureRmStorageAccountName: $(backendStorageAccount)
              backendAzureRmContainerName: $(backendContainerName)
              backendAzureRmKey: $(backendKey)

          - task: TerraformTaskV4@4
            displayName: 'Terraform Plan'
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: $(workingDirectory)
              environmentServiceNameAzureRM: 'azure-subscription'
              commandOptions: '-out=tfplan'

          - task: ArchiveFiles@2
            displayName: 'Archive Terraform Plan'
            inputs:
              rootFolderOrFile: '$(workingDirectory)'
              includeRootFolder: false
              archiveType: 'tar'
              archiveFile: '$(Build.ArtifactStagingDirectory)/tfplan.tar.gz'
              replaceExistingArchive: true

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Terraform Plan'
            inputs:
              targetPath: '$(Build.ArtifactStagingDirectory)'
              artifact: 'tfplan'
              publishLocation: 'pipeline'

  - stage: Apply
    displayName: 'Terraform Apply'
    dependsOn: Plan
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: ApplyJob
        displayName: 'Apply Terraform Changes'
        environment: 'production-infrastructure'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPipelineArtifact@2
                  displayName: 'Download Terraform Plan'
                  inputs:
                    artifact: 'tfplan'
                    path: '$(Pipeline.Workspace)/tfplan'

                - task: ExtractFiles@1
                  displayName: 'Extract Terraform Plan'
                  inputs:
                    archiveFilePatterns: '$(Pipeline.Workspace)/tfplan/tfplan.tar.gz'
                    destinationFolder: '$(Pipeline.Workspace)/terraform'
                    cleanDestinationFolder: true

                - task: TerraformInstaller@0
                  displayName: 'Install Terraform'
                  inputs:
                    terraformVersion: $(terraformVersion)

                - task: TerraformTaskV4@4
                  displayName: 'Terraform Apply'
                  inputs:
                    provider: 'azurerm'
                    command: 'apply'
                    workingDirectory: '$(Pipeline.Workspace)/terraform'
                    environmentServiceNameAzureRM: 'azure-subscription'
                    commandOptions: 'tfplan'

                - task: Bash@3
                  displayName: 'Output Terraform Results'
                  inputs:
                    targetType: 'inline'
                    workingDirectory: '$(Pipeline.Workspace)/terraform'
                    script: |
                      echo "Terraform apply completed successfully"
                      terraform output -json > $(Build.ArtifactStagingDirectory)/terraform-outputs.json

                - task: PublishPipelineArtifact@1
                  displayName: 'Publish Terraform Outputs'
                  inputs:
                    targetPath: '$(Build.ArtifactStagingDirectory)'
                    artifact: 'terraform-outputs'
                    publishLocation: 'pipeline'
